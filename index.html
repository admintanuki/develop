<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="canonical" href="https://fan-chart.com/">
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-PPEDDGQHPC"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-PPEDDGQHPC');
  </script>

  <title>【2026最新】STARTO(旧ジャニーズ) CD売上枚数比較・歴代グラフ推移 | Snow Man・SixTONES・なにわ男子ほか</title>
  <meta name="description" content="STARTO(旧ジャニーズ)所属アーティストの最新CD売上データを網羅。Snow Man、SixTONES、King & Prince、なにわ男子などの最新および歴代シングル・アルバム初動枚数をグラフで比較。2026年最新の売上傾向分析も掲載中。">
  
  <meta property="og:site_name" content="STARTO CD売上枚数比較サイト">
  <meta property="og:title" content="【2026最新】STARTO(旧ジャニーズ) CD売上枚数比較・歴代グラフ推移">
  <meta property="og:image" content="https://fan-chart.com/ogp.png">
  <meta name="twitter:card" content="summary_large_image">

  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://docs.google.com">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  
  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #334155;
      --sub: #94a3b8;
      --border: #e2e8f0;
      --accent-teal: #5D9C9F;
      --accent-hot: #f97316;
      --primary-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    }

    html { scroll-behavior: smooth; }

    body { 
      margin: 0; padding: 0; 
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Segoe UI", "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Meiryo", sans-serif; 
      background: var(--bg); color: var(--text); padding-bottom: 60px; overflow-x: hidden; line-height: 1.6; 
    }

    .utility-bar { background: #fff; border-bottom: 1px solid var(--border); padding: 10px 20px; display: flex; justify-content: flex-end; align-items: center; font-size: 12px; }
    .utility-right { display: flex; gap: 15px; }
    .utility-link { text-decoration: none; color: #64748b; font-weight: 600; display: flex; align-items: center; gap: 4px; position: relative; cursor: pointer; }
    
    .dropdown { position: relative; display: inline-block; }
    .dropdown::before { content: ""; position: absolute; top: 100%; right: 0; width: 100%; height: 10px; display: block; z-index: 100; }
    .dropdown-content { display: none; position: absolute; right: 0; background-color: #fff; min-width: 140px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1); z-index: 101; border: 1px solid var(--border); border-radius: 8px; margin-top: 8px; }
    @media (min-width: 1025px) { .dropdown:hover .dropdown-content { display: block; } }
    .dropdown-content.is-active { display: block; }
    .dropdown-content a { color: var(--text); padding: 10px 16px; text-decoration: none; display: block; font-size: 12px; border-bottom: 1px solid var(--border); }
    .dropdown-content a:last-child { border-bottom: none; }
    .dropdown-content a:hover { background-color: #f1f5f9; }

    .sticky-header { position: relative; z-index: 100; background: #fff; box-shadow: var(--primary-shadow); padding: 12px 10px; border-bottom: 1px solid var(--border); }
    .header-content { max-width: 1100px; margin: 0 auto; }
    
    .site-title { text-align: center; margin-bottom: 12px; }
    .site-title h1 { margin: 0; padding: 0; }
    .site-title .sub-name { display: block; font-size: 13px; color: #eba0b8; font-weight: 800; margin-bottom: 0px; letter-spacing: 0.02em; }
    .site-title .main-logo { display: block; font-family: "Georgia", serif; font-size: 32px; font-weight: 900; font-style: italic; color: #333; line-height: 1.1; margin: 2px 0 4px 0; }
    .site-title .main-name { display: block; font-size: 12px; font-weight: 700; color: #64748b; line-height: 1.2; }

    @media (min-width: 768px) {
      .site-title .sub-name { font-size: 15px; }
      .site-title .main-logo { font-size: 48px; }
      .site-title .main-name { font-size: 15px; }
    }
    
    .controls { display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; max-width: 800px; margin: 0 auto; }
    select { padding: 8px 2px; border-radius: 6px; border: 1px solid var(--border); background: #fff; width: 100%; color: var(--text); font-size: 11px; font-weight: 600; cursor: pointer; font-family: inherit; }

    @media (min-width: 768px) {
      .controls { gap: 12px; }
      select { padding: 10px 12px; font-size: 13px; border-radius: 8px; }
    }

    .chart-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 15px; padding-left: 5px; }
    .chart-tab { padding: 8px 16px; font-size: 13px; font-weight: 700; color: var(--sub); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s ease; }
    .chart-tab.is-active { color: var(--text); border-bottom: 2px solid var(--text); }

    .container { width: 100%; max-width: 1100px; margin: 20px auto; padding: 0 15px; box-sizing: border-box; display: flex; flex-direction: column; gap: 24px; }
    .content-wrapper { display: flex; flex-direction: column; gap: 28px; }
    .card { background: var(--card); border-radius: 16px; padding: 20px; box-shadow: var(--primary-shadow); border: 1px solid #fff; }

    /* 余白を縮小 */
    .group-buttons-wrapper { margin-bottom: 8px; }
    .group-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; margin-bottom: 4px; padding: 0 4px; }
    .group-btn { padding: 5px 12px; border-radius: 99px; border: 1px solid var(--border); background: #fff; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.2s ease; white-space: nowrap; }
    .group-btn.active { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

    @media (max-width: 767px) {
      .group-buttons { flex-wrap: nowrap; justify-content: flex-start; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
      .group-buttons::-webkit-scrollbar { display: none; }
    }

    .chart-wrapper { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 8px; }
    .chart-body { position: relative; height: 300px; min-width: 100%; }
    
    .chart-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; min-height: 24px; }
    .share-btn-mini { background: none; border: none; padding: 0; color: var(--accent-teal); font-size: 11px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px; }
    .share-btn-mini svg { width: 14px; height: 14px; fill: none; stroke: currentColor; stroke-width: 2.5; }

    .load-more-text { background: none; border: none; padding: 0; color: var(--sub); font-size: 11px; font-weight: 600; cursor: pointer; text-decoration: underline; margin-bottom: 4px; }

    .hot-area { padding: 12px 20px; }
    .hot-list { display: flex; flex-wrap: wrap; gap: 8px 16px; align-items: center; }
    .hot-label { font-size: 11px; font-weight: 800; color: var(--accent-hot); display: flex; align-items: center; gap: 4px; white-space: nowrap; border-right: 1px solid var(--border); padding-right: 12px; }
    .hot-label svg { width: 14px; height: 14px; fill: currentColor; }
    .hot-item { text-decoration: none; color: var(--text); font-size: 13px; font-weight: 400; transition: color 0.2s; display: flex; align-items: center; }
    .hot-item:hover { color: var(--accent-hot); }
    .hot-item::after { content: '>'; margin-left: 4px; font-size: 10px; opacity: 0.5; }

    .split-area { display: grid; grid-template-columns: 1fr; gap: 24px; }
    @media (min-width: 900px) { .split-area { grid-template-columns: 1fr 280px; align-items: start; } }

    .cd-list { display: grid; gap: 10px; }
    .cd-item-base { 
      display: grid; grid-template-columns: 1fr 90px; gap: 16px; padding: 14px 16px; 
      border: 1px solid var(--border); border-radius: 12px; text-decoration: none; 
      color: inherit; background: #fff; align-items: center; transition: all 0.2s ease; 
    }
    .cd-item-base.upcoming { 
      grid-template-columns: 64px 1fr 90px; 
      border: 1px solid #fed7aa; background-color: #fffaf5;
    }
    @media (max-width: 767px) {
      .cd-item-base { grid-template-columns: 1fr 80px; padding: 10px 12px; gap: 10px; }
      .cd-item-base.upcoming { grid-template-columns: 50px 1fr 80px; }
    }

    .cd-thumb { width: 64px; height: 64px; border-radius: 6px; overflow: hidden; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    @media (max-width: 767px) { .cd-thumb { width: 50px; height: 50px; } }
    .cd-thumb img { width: 100%; height: 100%; object-fit: cover; display: block; border: 1px solid var(--border); border-radius: 6px; }

    .cd-info-main { min-width: 0; } 
    .cd-title { font-weight: 700; font-size: 14px; display: block; margin-bottom: 4px; line-height: 1.4; color: #1e293b; word-break: break-all; overflow-wrap: break-word; }
    .meta { font-size: 10.5px; color: var(--sub); display: flex; align-items: center; flex-wrap: wrap; gap: 4px; }
    .badge { font-size: 9px; padding: 1px 5px; border-radius: 4px; color: #fff; font-weight: 700; }
    
    .sales-box { text-align: right; display: flex; flex-direction: column; gap: 4px; align-items: flex-end; flex-shrink: 0; }
    .sales-val { font-weight: 700; font-size: 14px; letter-spacing: -0.02em; white-space: nowrap; }
    .countdown { font-size: 10px; font-weight: 700; color: #ea580c; background: #fff7ed; padding: 1px 6px; border-radius: 99px; border: 1px solid #ffedd5; width: fit-content; white-space: nowrap; }

    .ext-link-icon { width: 11px; height: 11px; color: var(--sub); margin-left: 5px; vertical-align: middle; }
    .buy-label { font-size: 10px; color: var(--sub); font-weight: 600; margin-left: 2px; vertical-align: middle; white-space: nowrap; }

    .analysis-card .card-title, .history-card .card-title { font-size: 14px; font-weight: 700; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border); color: #475569; display: flex; align-items: center; gap: 6px; }
    .history-list { list-style: none; padding: 0; margin: 0; }
    .history-item { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dotted var(--border); }
    .history-date { font-size: 10px; color: var(--sub); display: block; margin-bottom: 2px; font-weight: 600; }
    .history-text { font-size: 12px; line-height: 1.4; color: #334155; }
    .back-to-top { position: fixed; bottom: 20px; right: 20px; background: var(--card); border: 1px solid var(--border); width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: var(--primary-shadow); cursor: pointer; z-index: 1000; opacity: 0; visibility: hidden; transition: 0.3s; text-decoration: none; color: var(--text); }
    .back-to-top.visible { opacity: 1; visibility: visible; }
    .spinner { width: 28px; height: 28px; border: 3px solid var(--border); border-top: 3px solid var(--accent-teal); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 12px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .analysis-btn { text-decoration: none; padding: 10px; border-radius: 8px; font-size: 12px; font-weight: 700; text-align: center; transition: all 0.2s; display: block; border: 1px solid; }
    .analysis-btn:hover { opacity: 0.8; transform: translateY(-1px); }
    .group-links-container { display: flex; flex-direction: column; gap: 8px; }
  </style>
</head>
<body>

<a href="#" class="back-to-top" id="backToTop"><svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:none; stroke:currentColor; stroke-width:2.5;"><path d="M4.5 15.75l7.5-7.5 7.5 7.5" /></svg></a>

<div class="utility-bar">
  <div class="utility-right">
    <div class="dropdown" id="groupDropdown">
      <span class="utility-link">グループ別</span>
      <div class="dropdown-content">
        <a href="https://fan-chart.com/snowman">Snow Man</a>
        <a href="https://fan-chart.com/sixtones">SixTONES</a>
        <a href="https://fan-chart.com/king-and-prince">King & Prince</a>
        <a href="https://fan-chart.com/naniwa-danshi">なにわ男子</a>
      </div>
    </div>
    <a href="#analysis" class="utility-link">分析</a>
    <a href="howto.html" class="utility-link">ガイド</a>
    <a href="terms.html" class="utility-link">規約</a>
  </div>
</div>

<header class="sticky-header">
  <div class="header-content">
    <div class="site-title">
      <h1>
        <span class="sub-name">STARTO ENTERTAINMENT(旧ジャニーズ)</span>
        <span class="main-logo">Fan Chart</span>
        <span class="main-name">【2026年最新】歴代シングル・アルバム売上枚数比較サイト</span>
      </h1>
    </div>
    <div class="controls">
      <select id="salesType"><option value="firstWeek" selected>初週</option><option value="firstDay">初日</option></select>
      <select id="filter"><option value="all">シングル&アルバム</option><option value="single">シングル</option><option value="album">アルバム</option></select>
      <select id="sortOrder" style="display:none;"><option value="date" selected>発売日順</option><option value="salesDesc">売上順</option></select>
    </div>
  </div>
</header>

<div class="container">
  <div id="loading" class="card"><div style="text-align:center; padding:40px;"><div class="spinner"></div>データを取得中...</div></div>

  <div id="mainContent" class="content-wrapper" style="display:none;">
    <div class="card">
      <div class="chart-tabs">
        <div class="chart-tab is-active" data-sort="date">発売日順</div>
        <div class="chart-tab" data-sort="salesDesc">売上順</div>
      </div>

      <div class="group-buttons-wrapper">
        <div style="font-size: 12px; font-weight: 400; color: #334155; margin-bottom: 4px; padding-left: 4px;">↓ 比較したいグループを選択（最大5つまで）</div>
        <div class="group-buttons" id="groupButtons"></div>
      </div>
      
      <div class="chart-wrapper" id="chartWrapper"><div class="chart-body" id="chartBody"><canvas id="salesChart"></canvas></div></div>
      <div class="chart-footer">
        <div id="chartBtnArea"></div>
        <button onclick="copyShareUrl()" class="share-btn-mini" id="shareBtn">
          <svg viewBox="0 0 24 24" id="shareIcon"><path d="M7.217 10.907a2.25 2.25 0 100 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186l9.566-5.314m-9.566 7.5l9.566 5.314m0 0a2.25 2.25 0 103.935 2.186 2.25 2.25 0 00-3.935-2.186zm0-12.814a2.25 2.25 0 103.933-2.185 2.25 2.25 0 00-3.933 2.185z" fill="currentColor"/></svg>
          <span id="shareBtnText">このグラフを共有</span>
        </button>
      </div>
    </div>

    <div class="card hot-area">
      <div class="hot-list">
        <span class="hot-label"><svg viewBox="0 0 24 24"><path d="M15.312 11.424a5.5 5.5 0 01-9.201 2.466l-.312-.311L4.5 17c0 3.866 3.134 7 7 7s7-3.134 7-7c0-2.116-1.03-4.03-2.688-5.576zM13.5 0s-4 4.5-4 8c0 1.5 1 3.5 3 4.5.5-2.5 2-4.5 4-4.5.5 5-2.5 9.5-6 11-1-.5-3.5-2.5-3.5-6.5 0-3.5 3.5-12.5 6.5-12.5z"/></svg>HOT</span>
        <a href="https://fan-chart.com/snowman" class="hot-item">Snow Man</a>
        <a href="https://fan-chart.com/sixtones" class="hot-item">SixTONES</a>
        <a href="https://fan-chart.com/king-and-prince" class="hot-item">King & Prince</a>
        <a href="https://fan-chart.com/naniwa-danshi" class="hot-item">なにわ男子</a>
      </div>
    </div>

    <div class="split-area">
      <div class="card">
        <div class="cd-list" id="cdList"></div>
        <div id="listBtnArea" style="text-align:center; margin-top:20px;"></div>
      </div>
      
      <div class="side-content">
        <section id="analysis" class="card analysis-card" style="margin-bottom: 24px;">
          <div class="card-title">2026年最新の売上傾向分析</div>
          <div id="analysisText" style="font-size: 12px; line-height: 1.7; color: #334155;">
            <p style="margin: 0 0 12px 0;"><strong>Snow Man</strong>が直近のアルバムでミリオンを達成するなど、圧倒的な数字を記録しており、固定ファンの強さがグラフにも表れています。</p>
            <p style="margin: 0 0 12px 0;">また、最新シングル『Stargaze』で初週33.0万枚を記録した<strong>SixTONES</strong>、2人体制移行後も30万枚越えの高水準を保つ<strong>King & Prince</strong>、そして『アシンメトリー / Black Nightmare』で前作を上回る推移を見せる<strong>なにわ男子</strong>の3組が、初動水準を保っています。</p>
          </div>
        </section>

        <section id="group-nav" class="card analysis-card" style="margin-bottom: 24px;">
          <div class="card-title">各グループ別 売上詳細データ</div>
          <div id="groupLinks" class="group-links-container">
            <a href="https://fan-chart.com/snowman" class="analysis-btn" style="color: #1b489d; border-color: rgba(27, 72, 157, 0.3); background: rgba(27, 72, 157, 0.05);">Snow Man ページ ></a>
            <a href="https://fan-chart.com/sixtones" class="analysis-btn" style="color: #555555; border-color: rgba(85, 85, 85, 0.3); background: rgba(85, 85, 85, 0.05);">SixTONES ページ ></a>
            <a href="https://fan-chart.com/king-and-prince" class="analysis-btn" style="color: #fab700; border-color: rgba(250, 183, 0, 0.3); background: rgba(250, 183, 0, 0.05);">King & Prince ページ ></a>
            <a href="https://fan-chart.com/naniwa-danshi" class="analysis-btn" style="color: #eba0b8; border-color: rgba(235, 160, 184, 0.3); background: rgba(235, 160, 184, 0.05);">なにわ男子 ページ ></a>
          </div>
        </section>
        <aside class="card history-card"><div class="card-title">更新履歴</div><ul class="history-list" id="historyList"></ul></aside>
      </div>
    </div>
  </div>
</div>

<script>
if(typeof ChartDataLabels !== 'undefined'){ Chart.register(ChartDataLabels); }

const SHEET_DATA_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQxQ9MthYXl_ZlJ3cmbzAqJZHI4e_wACYUhpdqK0aoHuwUlodXL182IXNUt__rALT6JounkCi8PK7mS/pub?gid=0&single=true&output=csv";
const SHEET_INFO_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQxQ9MthYXl_ZlJ3cmbzAqJZHI4e_wACYUhpdqK0aoHuwUlodXL182IXNUt__rALT6JounkCi8PK7mS/pub?gid=1448446296&single=true&output=csv";

const fixedGroupColors = { "Snow Man": "#1b489d", "timelesz": "#de6d6d", "Aぇ! group": "#5eb3bf", "なにわ男子": "#eba0b8", "SixTONES": "#555555", "King & Prince": "#fab700", "WEST.": "#1d9967", "Hey! Say! JUMP": "#39aeed", "DOMOTO": "#554435", "SUPER EIGHT": "#F7AF73", "Travis Japan": "#66b27e", "NEWS": "#8170b2", "Kis-My-Ft2": "#CFE394", "A.B.C-Z": "#f0897c" };
const fixedGroupOrder = Object.keys(fixedGroupColors);

let allProcessedData = [], cds = [], activeGroups = new Set(), chart = null, isFullDataLoaded = false;

document.querySelectorAll('.chart-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('is-active'));
    tab.classList.add('is-active');
    document.getElementById('sortOrder').value = tab.dataset.sort;
    render(true);
  });
});

const groupDropdown = document.getElementById('groupDropdown');
const dropdownContent = groupDropdown.querySelector('.dropdown-content');
groupDropdown.addEventListener('click', (e) => { e.stopPropagation(); dropdownContent.classList.toggle('is-active'); });
window.addEventListener('click', () => { dropdownContent.classList.remove('is-active'); });

function copyShareUrl() {
  const groups = Array.from(activeGroups).join(',');
  const type = document.getElementById("salesType").value;
  const filter = document.getElementById("filter").value;
  const sort = document.getElementById("sortOrder").value;
  const url = new URL(window.location.href);
  if(groups) url.searchParams.set('g', groups); else url.searchParams.delete('g');
  url.searchParams.set('t', type); url.searchParams.set('f', filter); url.searchParams.set('s', sort);
  navigator.clipboard.writeText(url.href).then(() => {
    const btnText = document.getElementById('shareBtnText');
    const originalText = btnText.innerText;
    btnText.innerText = "コピーしました！";
    setTimeout(() => btnText.innerText = originalText, 2000);
  });
}

function parseCSV(text) {
  const lines = text.trim().split('\n'); if (lines.length < 2) return [];
  const headers = lines[0].split(',').map(h => {
    const trimH = h.trim();
    return trimH.startsWith('\uFEFF') ? trimH.slice(1) : trimH;
  });
  return lines.slice(1).map(line => {
    const values = line.split(','); const obj = {};
    headers.forEach((h, i) => { obj[h] = values[i] ? values[i].replace(/\r/g, '').trim() : ""; });
    return obj;
  });
}

function initSettingsByUrl() {
    const params = new URLSearchParams(window.location.search);
    if(params.get('t')) document.getElementById("salesType").value = params.get('t');
    if(params.get('f')) document.getElementById("filter").value = params.get('f');
    if(params.get('s')) {
      const s = params.get('s');
      document.getElementById("sortOrder").value = s;
      document.querySelectorAll('.chart-tab').forEach(t => { t.classList.toggle('is-active', t.dataset.sort === s); });
    }
    if(params.get('g')) { params.get('g').split(',').forEach(g => activeGroups.add(decodeURIComponent(g))); isFullDataLoaded = true; }
}

async function loadData() {
  initSettingsByUrl();
  renderGroupButtons(true);
  try {
    const [resData, resInfo] = await Promise.all([fetch(SHEET_DATA_URL), fetch(SHEET_INFO_URL)]);
    const rawData = parseCSV(await resData.text());
    allProcessedData = rawData.map(d => ({ 
      title: d.title, group: d.group, releaseDate: d.releaseDate, category: d.category,
      firstDay: isNaN(parseInt(d.firstDay)) ? null : parseInt(d.firstDay),
      firstWeek: isNaN(parseInt(d.firstWeek)) ? null : parseInt(d.firstWeek),
      seller: d.seller || "",
      affiliate: d.affiliate || ""
    }));
    if(isFullDataLoaded) cds = allProcessedData;
    else cds = allProcessedData.filter(c => new Date(c.releaseDate) >= new Date("2024-01-01"));
    document.getElementById('loading').style.display = 'none';
    document.getElementById('mainContent').style.display = 'flex';
    renderGroupButtons(false); 
    render();
    if (resInfo.ok) processInfo(parseCSV(await resInfo.text()));
    if (!isFullDataLoaded && allProcessedData.length > cds.length) showLoadMoreButtons();
  } catch (e) { console.error(e); }
}

function loadAllRecords() {
  if (isFullDataLoaded) return;
  cds = allProcessedData; isFullDataLoaded = true;
  const btn = document.querySelector('.load-more-text'); if(btn) btn.remove();
}

function showLoadMoreButtons() {
  if (isFullDataLoaded) return;
  const btn = document.createElement('button');
  btn.className = 'load-more-text'; btn.textContent = '<< 2024年以前のデータも読み込む';
  btn.onclick = () => { loadAllRecords(); render(true); };
  document.getElementById('chartBtnArea').appendChild(btn);
}

function processInfo(data) {
  const histories = data.filter(d => d.type === 'history');
  document.getElementById('historyList').innerHTML = histories.map(h => `<li class="history-item"><span class="history-date">${h.date}</span><div class="history-text">${h.text}</div></li>`).join("");
}

function renderGroupButtons(isPreload = false) {
  let sortedGroups = [];
  if (isPreload) sortedGroups = fixedGroupOrder;
  else {
    const latestValid = {};
    allProcessedData.forEach(cd => {
      if (cd.category === 'single' && cd.firstWeek !== null) {
        const cur = latestValid[cd.group];
        if (!cur || new Date(cd.releaseDate) > new Date(cur.date)) latestValid[cd.group] = { date: cd.releaseDate, sales: cd.firstWeek };
      }
    });
    sortedGroups = [...new Set(allProcessedData.map(c => c.group))].sort((a, b) => (latestValid[b]?.sales || -1) - (latestValid[a]?.sales || -1));
  }
  document.getElementById("groupButtons").innerHTML = sortedGroups.map(g => {
    const active = activeGroups.has(g);
    const color = fixedGroupColors[g] || "#7f8c8d";
    return `<button class="group-btn ${active?'active':''}" data-group="${g}" style="border-color:${color}; color:${active?'#fff':color}; background:${active?color:'#fff'}">${g}</button>`;
  }).join("");
  document.querySelectorAll(".group-btn").forEach(btn => {
    btn.onclick = () => {
      if(!isFullDataLoaded) loadAllRecords();
      const g = btn.dataset.group;
      if (activeGroups.has(g)) activeGroups.delete(g);
      else if (activeGroups.size < 5) activeGroups.add(g);
      else return alert("最大5グループまで");
      const url = new URL(window.location.href);
      if(activeGroups.size) url.searchParams.set('g', Array.from(activeGroups).join(',')); else url.searchParams.delete('g');
      window.history.replaceState({}, '', url);
      renderGroupButtons(false); render(true);
    };
  });
}

function render(shouldAnimate = false) {
  const type = document.getElementById("salesType").value;
  const f = document.getElementById("filter").value;
  const s = document.getElementById("sortOrder").value;
  let filtered = cds.filter(c => (activeGroups.size === 0 || activeGroups.has(c.group)) && (f === "all" || c.category === f));
  let sortedList = [...filtered].sort((a, b) => s === "date" ? b.releaseDate.localeCompare(a.releaseDate) : (b[type] || -1) - (a[type] || -1));
  
  let chartSource = filtered.filter(c => c[type] !== null).sort((a, b) => {
    if(s === "date") return a.releaseDate.localeCompare(b.releaseDate);
    return (a[type] || 0) - (b[type] || 0);
  });
  
  const isSingle = activeGroups.size === 1;
  const chartWrapper = document.getElementById("chartWrapper");
  const chartBody = document.getElementById("chartBody");
  const finalWidth = Math.max(chartWrapper.clientWidth, chartSource.length * (isSingle ? 60 : 45));
  chartBody.style.width = `${finalWidth}px`;
  if (chart) chart.destroy();
  const color = isSingle ? fixedGroupColors[Array.from(activeGroups)[0]] : null;
  chart = new Chart(document.getElementById("salesChart"), {
    type: isSingle ? 'line' : 'bar',
    data: {
      labels: chartSource.map(c => c.title.substring(0, 7) + (c.title.length > 7 ? ".." : "")),
      datasets: [{
        data: chartSource.map(c => c[type]),
        backgroundColor: isSingle ? color + '33' : chartSource.map(c => (fixedGroupColors[c.group] || "#ddd")),
        borderColor: color || "#5D9C9F",
        borderWidth: isSingle ? 2 : 0, borderRadius: 4, fill: true, tension: 0.3, 
        pointBackgroundColor: "#fff", pointBorderColor: color, pointRadius: isSingle ? 4 : 0
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      animation: shouldAnimate ? { duration: 800 } : false,
      plugins: { 
        legend: { display: false },
        tooltip: {
          callbacks: {
            title: (context) => {
              const d = chartSource[context[0].dataIndex];
              return `${d.group} / ${d.title}`; 
            },
            label: (context) => `${(context.raw / 10000).toFixed(1)}万枚`
          }
        },
        datalabels: { anchor: 'end', align: 'top', color: '#64748b', font: { size: 9, weight: '600' }, formatter: v => (v/10000).toFixed(1) }
      },
      scales: { 
        y: { ticks: { callback: v => (v/10000) + "万", font: {size: 9} }, grace: '10%' },
        x: { ticks: { font: {size: 8}, maxRotation: 45, minRotation: 45 }, grid: { display: false } }
      }
    }
  });
  if (finalWidth > chartWrapper.clientWidth) chartWrapper.scrollLeft = finalWidth;
  const today = new Date(); today.setHours(0,0,0,0);

  document.getElementById("cdList").innerHTML = sortedList.map(c => {
    const days = Math.ceil((new Date(c.releaseDate).setHours(0,0,0,0) - today) / 86400000);
    const color = fixedGroupColors[c.group] || "#7f8c8d";
    const salesValExists = c[type] !== null;
    const salesDisp = salesValExists ? (c[type]/10000).toFixed(1) + '万枚' : (days>0?'予約受付中':'集計中');
    const isUpcomingLayout = !salesValExists;
    
    const countdownHtml = days>0 ? `<div class="countdown">あと${days}日</div>` : days===0 ? `<div class="countdown" style="background:#f97316;color:#fff;border:none;">本日</div>` : "";

    const content = `
      ${isUpcomingLayout ? `<div class="cd-thumb">${c.affiliate ? `<img src="${c.affiliate}">` : ''}</div>` : ''}
      <div class="cd-info-main">
        <span class="cd-title" style="color:${color}">
          ${c.title}
          ${c.seller ? `
            <svg class="ext-link-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
            </svg>
            ${isUpcomingLayout ? '<span class=\"buy-label\">購入はこちら</span>' : ''}
          ` : ''}
        </span>
        <div class="meta">${c.group} | ${c.releaseDate} <span class="badge" style="background:${color}">${c.category.toUpperCase()}</span></div>
      </div>
      <div class="sales-box">
        <div class="sales-val" style="color:${days>0?'#f97316':color}">${salesDisp}</div>
        ${countdownHtml}
      </div>
    `;
    return c.seller ? `<a href="${c.seller}" target="_blank" rel="noopener noreferrer" class="cd-item-base ${isUpcomingLayout?'upcoming':''}">${content}</a>` : `<div class="cd-item-base ${isUpcomingLayout?'upcoming':''}">${content}</div>`;
  }).join("");
}
[document.getElementById("salesType"), document.getElementById("filter")].forEach(el => el.addEventListener("change", () => render(true)));
window.addEventListener('scroll', () => { document.getElementById('backToTop').classList.toggle('visible', window.scrollY > 300); });
loadData();
</script>
</body>
</html>
